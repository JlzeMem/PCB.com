<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2S PCB Pro - Advanced PCB Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Barcode Scanner -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <!-- TensorFlow.js for Component Recognition -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #60a5fa, #a78bfa);
            min-height: 100vh; /* Ensure body takes full viewport height */
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        
        .sidebar {
            width: 280px;
            transform: translateX(-280px);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            position: fixed; /* Keep sidebar fixed */
            top: 0;
            left: 0;
            height: 100%;
            overflow-y: auto; /* Enable scrolling for long menus */
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .overlay {
            display: none;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* Adjust main content for smaller screens */
        #mainContent {
            padding: 1rem; /* Smaller padding on mobile */
            margin: 0 auto; /* Center content */
            width: 100%; /* Full width on mobile */
            max-width: 100%; /* Ensure it doesn't exceed screen width */
            box-sizing: border-box; /* Include padding in width */
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        @media (min-width: 768px) { /* Medium screens and up */
            #mainContent {
                padding: 2rem; /* Larger padding on desktop */
                max-width: 4xl; /* Max width for desktop */
            }
        }
        
        .zoomable-image {
            cursor: zoom-in;
            transition: transform 0.2s ease-in-out;
        }
        
        .zoomable-image.zoomed {
            transform: scale(1.5);
            cursor: zoom-out;
        }
        
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px; /* Fixed height for scanner view */
            overflow: hidden;
            background-color: black; /* Background for video */
        }
        
        #scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid #3b82f6;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the container without distortion */
        }
        
        .component-tag {
            position: absolute;
            background: rgba(59, 130, 246, 0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
        }

        /* Modal styling for mobile */
        .fixed.inset-0 {
            padding: 1rem; /* Add some padding to modals on small screens */
        }
        .fixed.inset-0 > div {
            max-width: 100%; /* Modals take full width on mobile */
            border-radius: 0.75rem; /* Rounded corners */
        }
        @media (max-width: 767px) { /* Apply to small screens */
            .fixed.inset-0 > div {
                margin: 0.5rem; /* Small margin */
            }
            #scannerModal > div, #componentRecognitionModal > div, #versionHistoryModal > div {
                width: calc(100% - 1rem); /* Full width minus padding */
                min-height: 90vh; /* Take most of the height */
                overflow-y: auto; /* Allow scrolling within modal */
            }
            .flex-col.md:flex-row {
                flex-direction: column; /* Stack elements vertically in modals on mobile */
            }
            .md:w-64 {
                width: 100%; /* Full width for side panels in modals on mobile */
            }
        }

        .toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 1rem; /* Only horizontal padding when closed */
        }
        .toggle-content.open {
            max-height: 500px; /* Adjust as needed for content length */
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
            padding: 1rem; /* Apply full padding when open */
        }

        /* Dark Theme Overrides */
        body[data-theme="dark"] {
            background: linear-gradient(to bottom right, #1a202c, #2d3748); /* Darker gradient background for the body */
            color: #e2e8f0; /* Light grey for general text */
        }

        body[data-theme="dark"] #mainContent {
            background-color: #2d3748; /* Darker background for the main content area */
            color: #e2e8f0; /* Light grey text */
        }

        body[data-theme="dark"] h1,
        body[data-theme="dark"] h2,
        body[data-theme="dark"] h3,
        body[data-theme="dark"] h4 {
            color: #f7fafc; /* Lighter text for headings */
        }

        body[data-theme="dark"] p,
        body[data-theme="dark"] label,
        body[data-theme="dark"] td,
        body[data-theme="dark"] th {
            color: #e2e8f0; /* Light grey for paragraphs, labels, table text */
        }

        body[data-theme="dark"] .sidebar {
            background-color: #1a202c; /* Ensure sidebar is dark */
        }

        body[data-theme="dark"] .sidebar a {
            color: #e2e8f0; /* Light grey for sidebar links */
        }

        body[data-theme="dark"] .sidebar a:hover {
            color: #90cdf4; /* Lighter hover for sidebar links */
        }

        body[data-theme="dark"] .bg-gray-100 {
            background-color: #4a5568 !important; /* Darker background for elements like table headers, pcb list items */
        }

        body[data-theme="dark"] .bg-gray-50 {
            background-color: #4a5568 !important; /* Darker background for elements like image preview container, search results, settings cards */
        }

        body[data-theme="dark"] .border-gray-200,
        body[data-theme="dark"] .border-gray-300 {
            border-color: #4a5568 !important; /* Darker borders */
        }

        body[data-theme="dark"] .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.18) !important; /* Darker shadows */
        }

        body[data-theme="dark"] input[type="text"],
        body[data-theme="dark"] textarea,
        body[data-theme="dark"] select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #6b7280;
        }

        body[data-theme="dark"] input[type="text"]::placeholder,
        body[data-theme="dark"] textarea::placeholder {
            color: #a0aec0;
        }

        /* Specific for modals */
        body[data-theme="dark"] #scannerModal > div,
        body[data-theme="dark"] #componentRecognitionModal > div,
        body[data-theme="dark"] #versionHistoryModal > div {
            background-color: #2d3748 !important;
            color: #e2e8f0 !important;
        }

        body[data-theme="dark"] #scannerResult,
        body[data-theme="dark"] #componentResults,
        body[data-theme="dark"] #comparisonResults {
            color: #e2e8f0 !important;
        }

        body[data-theme="dark"] .toggle-button {
            background-color: #4a5568 !important;
            color: #f7fafc !important;
        }
        body[data-theme="dark"] .toggle-button:hover {
            background-color: #6b7280 !important;
        }
        body[data-theme="dark"] .toggle-content {
            background-color: #2d3748 !important;
            color: #e2e8f0 !important;
            border-top-color: #4a5568 !important;
        }

        /* New custom animation for heading */
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fadeInScale {
            animation: fadeInScale 1s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative">

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 text-center">Scan Barcode/QR Code</h2>
            <div class="scanner-container mb-4 rounded-lg overflow-hidden">
                <video id="scanner-video"></video>
                <div id="scanner-overlay"></div>
            </div>
            <div id="scannerResult" class="text-center mb-4 font-semibold text-gray-800"></div>
            <div class="flex flex-col space-y-2">
                <button id="startScanner" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Start Scanner</button>
                <button id="stopScanner" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200">Stop Scanner</button>
                <button id="closeScanner" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Component Recognition Modal -->
    <div id="componentRecognitionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-4xl relative">
            <h2 class="text-2xl font-bold mb-4 text-center">PCB Component Recognition</h2>
            <div class="flex flex-col gap-4">
                <div class="flex-1">
                    <div class="border-2 border-gray-300 rounded-lg p-2 flex justify-center items-center h-64 md:h-96 bg-gray-100 overflow-hidden">
                        <img id="componentRecognitionImage" class="max-w-full max-h-full object-contain rounded-lg shadow-md" src="https://placehold.co/400x200/cccccc/333333?text=Upload+PCB+Image" alt="PCB for Component Recognition">
                    </div>
                    <input type="file" id="componentRecognitionInput" accept="image/*" class="mt-2 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-semibold mb-2 text-gray-800">Detected Components:</h3>
                    <div id="componentResults" class="bg-gray-50 p-4 rounded-lg h-48 md:h-64 overflow-y-auto text-gray-700">
                        <p class="text-gray-500">No components detected yet. Upload a PCB image to analyze.</p>
                    </div>
                    <button id="analyzeComponents" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg w-full hover:bg-purple-700 transition duration-200">Analyze Components</button>
                </div>
            </div>
            <button id="closeComponentRecognition" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 rounded-full p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Version History Modal -->
    <div id="versionHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-3xl h-5/6 flex flex-col relative">
            <h2 class="text-2xl font-bold mb-4 text-center">Version History</h2>
            <div class="flex-1 overflow-y-auto mb-4">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border text-left text-gray-700">Version</th>
                            <th class="p-2 border text-left text-gray-700">Date</th>
                            <th class="p-2 border text-left text-gray-700">Changes</th>
                            <th class="p-2 border text-left text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="versionHistoryTable">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">No version history available.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end">
                <button id="closeVersionHistory" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">Close</button>
            </div>
            <button id="closeVersionHistoryTop" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 rounded-full p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main App UI -->
    <button id="menuButton" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg z-20 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>

    <!-- Sidebar Menu with additional options -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-gray-800 text-white p-6 shadow-xl flex flex-col">
        <h2 class="text-2xl font-bold mb-6">Menu</h2>
        <nav class="flex-grow">
            <ul>
                <li class="mb-4"><a href="#" id="homeMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">Home</a></li>
                <li class="mb-4"><a href="#" id="addPictureMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">Add PCB</a></li>
                <li class="mb-4"><a href="#" id="searchMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">Search</a></li>
                <li class="mb-4"><a href="#" id="databaseMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">Database</a></li>
                <li class="mb-4"><a href="#" id="scanCompareMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">Scan/Compare</a></li>
                <li class="mb-4"><a href="#" id="settingsMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">Settings</a></li>
                <li class="mb-4"><a href="#" id="appCreatorMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">App Creator</a></li>
                <li><a href="#" id="aboutMenuItem" class="text-lg hover:text-blue-300 transition duration-200 block py-1">About Us</a></li>
            </ul>
        </nav>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay fixed inset-0"></div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white p-3 rounded-lg shadow-lg z-50 hidden transition-opacity duration-300 opacity-0">
        This is a message!
    </div>

    <!-- Main Content Container -->
    <div id="mainContent" class="transition-transform duration-300 ease-in-out bg-white p-8 rounded-xl shadow-2xl text-center max-w-4xl w-full mx-auto">
        <!-- Home Section -->
        <div id="homeSection">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-4 animate-bounce animate-fadeInScale">
                E2S PCB Pro
            </h1>
            <p class="text-lg text-gray-700 mb-6">
                Advanced PCB management for your safety systems<br>
                Worldwide availability - global approvals - 10 year warranty
            </p>

            <div class="mb-6 border-2 border-gray-300 rounded-lg p-2 flex justify-center items-center h-48 bg-gray-100 overflow-hidden">
                <img id="homePageDisplayImage" class="max-w-full max-h-full object-contain rounded-lg shadow-md" src="https://placehold.co/400x200/cccccc/333333?text=No+Homepage+Image" alt="Homepage Image Placeholder">
            </div>

            <div class="flex flex-col gap-4 mt-8">
                <button id="homeSearchButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
                    Search Database
                </button>
            </div>
        </div>

        <!-- About Us Section -->
        <div id="aboutUsSection" class="hidden text-left">
            <button id="backToAboutMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">E2S Warning Signals</h2>

            <div class="space-y-4">
                <div class="border border-gray-200 rounded-lg shadow-sm">
                    <button class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 font-semibold text-lg text-gray-800 flex justify-between items-center toggle-button" data-target="aboutUsContent">
                        About Us
                        <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="aboutUsContent" class="toggle-content text-gray-700 border-t border-gray-200">
                        E2S is the worldâ€™s leading independent signalling manufacturer.
                        We specialise in the design, development and manufacture of high performance audible and visual signals for commercial, industrial, marine and hazardous locations with over 30 years of expertise.
                        Our head office and manufacturing operations are located in London, UK with extensive facilities for design, manufacture, quality assurance, testing and dispatch along with a customer service centre serving global markets.
                        Additionally, a dedicated distribution hub and sales operation is based in Houston, Texas principally serving North and South American customers as well as supporting projects globally. An international network of distribution partners and system integrators ensure worldwide product availability and local technical support.
                    </div>
                </div>

                <div class="border border-gray-200 rounded-lg shadow-sm">
                    <button class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 font-semibold text-lg text-gray-800 flex justify-between items-center toggle-button" data-target="servingSectorContent">
                        Serving your sector
                        <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="servingSectorContent" class="toggle-content text-gray-700 border-t border-gray-200">
                        We believe that technical excellence can be achieved through sharing best practice and understanding the requirements of each sector. Our products have proven performance and we can offer standard and bespoke solutions to diverse applications combined with dedicated expert advice. Our signalling equipment can be utilized in a vast range of sectors and applications including:
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>Energy: on and off shore extraction and processing & storage</li>
                            <li>Mining: surface & sub-surface</li>
                            <li>Marine: on board and land based infrastructure</li>
                            <li>Chemical: manufacturing & storage</li>
                            <li>Transportation: rail & material handling</li>
                            <li>General industrial: process control and safety</li>
                        </ul>
                        <p class="mt-2">Should you have a specific query about product applications, please contact us with your requirements.</p>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-lg shadow-sm">
                    <button class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 font-semibold text-lg text-gray-800 flex justify-between items-center toggle-button" data-target="productDevelopmentContent">
                        Product Development
                        <svg class="w-5 h-5 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="productDevelopmentContent" class="toggle-content text-gray-700 border-t border-gray-200">
                        <p>We are committed to collaborative research and product development. Underpinning our product development strategy is a close collaboration with our customers ensuring we create effective and functional products to meet your needs and those of ever changing markets.</p>
                        <p class="mt-2">Working together with system integrators, engineers, specifiers and clients we have developed product solutions to precise requirements with substantiated benefits such as ease of interface, installation, programming and overall performance that all our customers can benefit from every day.</p>
                        <p class="mt-2">Additionally, we have a long history of manufacturing products to specific requirements including alarm tone frequencies, tone patterns, stage configurations and housing colours. Please contact us with your requirements today.</p>
                        <h4 class="font-semibold mt-4 mb-2 text-gray-800">Hazardous Area</h4>
                        <p class="font-medium text-gray-700">Browse by type:</p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Visual</li>
                            <li>Audible</li>
                            <li><li>Combination</li>
                            <li>Alarm Bars</li>
                            <li>Status Lamps</li>
                            <li>Manual Call Points</li>
                            <li>Junction Boxes</li>
                            <li>Detectors</li>
                        </ul>
                        <p class="font-medium text-gray-700 mt-2">Browse by family:</p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>IS CI D1, Zone 0</li>
                            <li>BEx Zone 1, 21</li>
                            <li>GNEx Zone 1, 21</li>
                            <li>STEx Zone 1, 21</li>
                            <li>D1x CI/II D1, Zone 1</li>
                            <li>D2x CI/II D2, Zone 2</li>
                            <li>E2x CI/II D2, Zone 2</li>
                        </ul>
                        <h4 class="font-semibold mt-4 mb-2 text-gray-800">Fire & Industrial</h4>
                        <p class="font-medium text-gray-700">Browse by type:</p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Visual</li>
                            <li>Audible</li>
                            <li>Combination</li>
                            <li>Manual Call Points</li>
                        </ul>
                        <p class="font-medium text-gray-700 mt-2">Browse by family:</p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>Spectra Audible & visual</li>
                            <li>AlertAlarm Audible</li>
                            <li>AlertAlight Audible & visual</li>
                            <li>Sonora Audible</li>
                            <li>GPH Buzzers</li>
                            <li>Appello User recordable</li>
                            <li>M Heavy industrial</li>
                            <li>SpectrAlarm Audible & visual</li>
                            <li>Hootronic Sirens, Bells & Buzzers</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Picture Section (enhanced) -->
        <div id="addPictureSection" class="hidden text-left">
            <button id="backToAddMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 id="addPictureTitle" class="text-3xl font-bold text-gray-900 mb-6 text-center">Add New PCB</h2>

            <div class="flex flex-col gap-6">
                <div>
                    <div id="imagePreviewsContainer" class="mb-4 flex flex-wrap justify-center gap-2 border border-gray-200 p-2 rounded-lg bg-gray-50 min-h-[100px] items-center">
                        <p class="text-gray-500 text-sm text-center w-full">Upload images below.</p>
                    </div>

                    <div class="mb-4">
                        <label for="pictureNameInput" class="block text-gray-700 text-sm font-bold mb-2">PCB Name:</label>
                        <input type="text" id="pictureNameInput" placeholder="Enter PCB name (e.g., D1x_D2x-GROUP)" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <div class="mb-4">
                        <label for="cameraInput" class="block text-gray-700 text-sm font-bold mb-2">Take Photo (Camera):</label>
                        <input type="file" id="cameraInput" accept="image/*" capture="camera" multiple class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2 focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="galleryInput" class="block text-gray-700 text-sm font-bold mb-2">Select from Gallery:</label>
                        <input type="file" id="galleryInput" accept="image/*" multiple class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none p-2 focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-6">
                        <label for="descriptionInput" class="block text-gray-700 text-sm font-bold mb-2">Description:</label>
                        <textarea id="descriptionInput" rows="4" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline resize-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            </div>

            <button id="addPictureButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105 w-full">
                Add PCB & Description
            </button>
            <button id="cancelEditButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105 w-full mt-2 hidden">
                Cancel Edit
            </button>

            <hr class="my-8 border-t border-gray-300">

            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">Your PCBs</h3>
            <div id="addedPicturesList" class="space-y-6">
                <p class="text-gray-500 text-center" id="noPicturesMessage">No PCBs added yet.</p>
            </div>
        </div>

        <!-- Search Section (enhanced) -->
        <div id="searchSection" class="hidden text-left">
            <button id="backToSearchMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Search PCBs</h2>

            <div class="flex flex-col gap-4 mb-6">
                <div>
                    <label for="searchQueryInput" class="block text-gray-700 text-sm font-bold mb-2">Search Text:</label>
                    <input type="text" id="searchQueryInput" placeholder="Enter description to search..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex flex-col space-y-2 mb-6">
                <button id="searchButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
                    Search
                </button>
                <button id="resetSearchButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 hover:scale-105">
                    Reset
                </button>
            </div>

            <hr class="my-8 border-t border-gray-300">

            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">Search Results</h3>
            <div id="searchResultsList" class="space-y-6">
                <p class="text-gray-500 text-center" id="noSearchResultsMessage">No search results yet.</p>
            </div>
        </div>

        <!-- Database Section (enhanced) -->
        <div id="databaseSection" class="hidden text-left relative">
            <button id="backToDatabaseMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Your PCB Database</h2>

            <div class="flex flex-col space-y-2 mb-6">
                <button id="generatePdfButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300">
                    Generate PDF
                </button>
                <button id="sharePdfButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg">
                    Share PDF
                </button>
                <button id="exportCsvButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300">
                    Export CSV
                </button>
                <!-- Removed Refresh Button as per user request -->
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0">
                <div class="text-gray-700">
                    Showing <span id="itemCount">0</span> items
                </div>
                <div class="flex items-center">
                    <label for="itemsPerPage" class="text-gray-700 text-sm mr-2">Items per page:</label>
                    <select id="itemsPerPage" class="border rounded-lg py-1 px-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-2 px-4 border text-left text-gray-700">Preview</th>
                            <th class="py-2 px-4 border text-left text-gray-700">Name</th>
                            <th class="py-2 px-4 border text-left text-gray-700">Barcode</th>
                            <th class="py-2 px-4 border text-left text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="databaseItemsTable">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">No PCBs in database.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-center mt-4 space-y-2 sm:space-y-0">
                <div class="flex space-x-2">
                    <button id="prevPage" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-lg disabled:opacity-50 transition duration-200" disabled>
                        Previous
                    </button>
                    <button id="nextPage" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-lg disabled:opacity-50 transition duration-200" disabled>
                        Next
                    </button>
                </div>
                <div class="text-gray-700">
                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </div>
            </div>
        </div>

        <!-- Scan/Compare Section -->
        <div id="scanCompareSection" class="hidden text-left">
            <button id="backToScanCompareMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Scan and Compare PCB</h2>

            <div class="flex flex-col gap-6">
                <div>
                    <label for="scanCompareCameraInput" class="block text-gray-700 text-sm font-bold mb-2">Capture Image for Comparison:</label>
                    <div class="border-2 border-gray-300 rounded-lg p-2 flex justify-center items-center h-64 md:h-96 bg-gray-100 overflow-hidden mb-4">
                        <img id="scanCompareImage" class="max-w-full max-h-full object-contain rounded-lg shadow-md" src="https://placehold.co/400x200/cccccc/333333?text=Capture+Image" alt="Image for Comparison">
                    </div>
                    <input type="file" id="scanCompareCameraInput" accept="image/*" capture="camera" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2 text-gray-800">Comparison Results:</h3>
                    <div id="comparisonResults" class="bg-gray-50 p-4 rounded-lg h-48 md:h-64 overflow-y-auto text-gray-700">
                        <p class="text-gray-500">Capture an image and click "Compare" to find a match.</p>
                    </div>
                    <button id="compareImageButton" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg w-full hover:bg-blue-700 transition duration-200">Compare Image</button>
                    <div class="mt-4">
                        <label for="barcodeInputScanCompare" class="block text-gray-700 text-sm font-bold mb-2">Barcode/QR Code (Optional):</label>
                        <div class="flex flex-col space-y-2">
                            <input type="text" id="barcodeInputScanCompare" placeholder="Scan or enter barcode" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">
                            <button id="scanBarcodeFromScanCompare" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">Scan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- App Creator Section -->
        <div id="appCreatorSection" class="hidden text-left">
            <button id="backToAppCreatorMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">App Creator</h2>
            <p class="text-lg text-gray-700 text-center">
                The creator of this app is Joel Menezes.
            </p>
        </div>


        <!-- Settings Section (enhanced) -->
        <div id="settingsSection" class="hidden text-left">
            <button id="backToSettingsMenu" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Main Menu
            </button>
            <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">Settings</h2>

            <div class="flex flex-col gap-6">
                <div class="p-4 border rounded-lg shadow-sm bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">User Preferences</h3>
                    <div class="mb-4">
                        <label for="themeSelect" class="block text-gray-700 text-sm font-bold mb-2">App Theme:</label>
                        <select id="themeSelect" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-blue-500">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <button id="savePreferencesButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 w-full">Save Preferences</button>
                </div>

                <div class="p-4 border rounded-lg shadow-sm bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Data Management</h3>
                    <div class="mb-4">
                        <button id="backupDataButton" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300">Backup Data</button>
                    </div>
                    <div class="mb-4">
                        <button id="restoreDataButton" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300">Restore Data</button>
                        <input type="file" id="restoreFileInput" accept=".csv" class="hidden">
                    </div>
                </div>

                <div class="p-4 border rounded-lg shadow-sm bg-gray-50">
                    <h3 class="text-xl font-semibold mb-3 text-gray-800">Homepage Display Image</h3>
                    <div class="mb-4">
                        <label for="homepageImageInput" class="block text-gray-700 text-sm font-bold mb-2">Select Image:</label>
                        <input type="file" id="homepageImageInput" accept="image/*" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="applyHomepageImageButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300">Apply Image to Homepage</button>
                </div>
            </div>
        </div>

        <!-- JavaScript for interactivity and Local Storage -->
        <script type="module">
            // --- Global Variables ---
            let currentPcbId = null; // For editing PCBs
            let currentImages = []; // Stores base64 images for the current PCB being added/edited
            let allPcbs = []; // Stores all PCBs loaded from Local Storage
            let currentPage = 1;
            let itemsPerPage = 10;

            // --- Utility Functions ---
            function showMessage(message, type = 'info') {
                const messageBox = document.getElementById('messageBox');
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'opacity-0', 'bg-red-600', 'bg-green-600', 'bg-gray-800');
                messageBox.classList.add('opacity-100');

                if (type === 'error') {
                    messageBox.classList.add('bg-red-600');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-600');
                } else {
                    messageBox.classList.add('bg-gray-800');
                }

                setTimeout(() => {
                    messageBox.classList.remove('opacity-100');
                    messageBox.classList.add('opacity-0');
                    messageBox.addEventListener('transitionend', () => {
                        messageBox.classList.add('hidden');
                        messageBox.classList.remove('bg-red-600', 'bg-green-600', 'bg-gray-800');
                    }, { once: true });
                }, 3000);
            }

            // Function to switch sections and manage menu button visibility
            function showSection(sectionId) {
                document.querySelectorAll('#mainContent > div').forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');
                closeSidebar(); // Close sidebar after navigation

                // Hide menu button if not on home section
                if (sectionId === 'homeSection') {
                    menuButton.classList.remove('hidden');
                } else {
                    menuButton.classList.add('hidden');
                }
            }

            // --- Sidebar and Overlay Logic ---
            const menuButton = document.getElementById('menuButton');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            menuButton.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            });

            overlay.addEventListener('click', () => {
                closeSidebar();
            });

            function closeSidebar() {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }

            // --- Local Storage Management ---
            function savePcbsToLocalStorage() {
                localStorage.setItem('pcbs', JSON.stringify(allPcbs));
            }

            function loadPcbsFromLocalStorage() {
                const storedPcbs = localStorage.getItem('pcbs');
                allPcbs = storedPcbs ? JSON.parse(storedPcbs) : [];
                // Ensure versionHistory is parsed if it was stringified
                allPcbs.forEach(pcb => {
                    if (pcb.versionHistory) {
                        pcb.versionHistory = pcb.versionHistory.map(entry => {
                            if (typeof entry.data === 'string') {
                                try {
                                    entry.data = JSON.parse(entry.data);
                                } catch (e) {
                                    console.error("Error parsing version history data:", e);
                                }
                            }
                            return entry;
                        });
                    }
                });
            }

            // --- Navigation Event Listeners ---
            document.getElementById('homeMenuItem').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('addPictureMenuItem').addEventListener('click', () => {
                showSection('addPictureSection');
                // Reset form when navigating to Add PCB section
                resetAddPcbForm();
                document.getElementById('addPictureTitle').textContent = 'Add New PCB';
                document.getElementById('addPictureButton').textContent = 'Add PCB & Description';
                document.getElementById('cancelEditButton').classList.add('hidden');
            });
            document.getElementById('searchMenuItem').addEventListener('click', () => showSection('searchSection'));
            document.getElementById('databaseMenuItem').addEventListener('click', () => {
                showSection('databaseSection');
                loadPcbsFromLocalStorage(); // Refresh database when navigating to it
                renderDatabaseItems();
            });
            document.getElementById('scanCompareMenuItem').addEventListener('click', () => showSection('scanCompareSection')); // New menu item
            document.getElementById('settingsMenuItem').addEventListener('click', () => showSection('settingsSection'));
            document.getElementById('appCreatorMenuItem').addEventListener('click', () => showSection('appCreatorSection')); // New menu item
            document.getElementById('aboutMenuItem').addEventListener('click', () => showSection('aboutUsSection'));

            // Back buttons for sections
            document.getElementById('backToAboutMenu').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('backToAddMenu').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('backToSearchMenu').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('backToDatabaseMenu').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('backToScanCompareMenu').addEventListener('click', () => showSection('homeSection')); // New back button
            document.getElementById('backToSettingsMenu').addEventListener('click', () => showSection('homeSection'));
            document.getElementById('backToAppCreatorMenu').addEventListener('click', () => showSection('homeSection')); // New back button

            // Home section buttons
            document.getElementById('homeSearchButton').addEventListener('click', () => showSection('searchSection'));
            // The following lines were removed as per the user's request:
            // document.getElementById('scanBarcodeButton').addEventListener('click', () => document.getElementById('scannerModal').classList.remove('hidden'));
            // document.getElementById('componentRecognitionButton').addEventListener('click', () => document.getElementById('componentRecognitionModal').classList.remove('hidden'));

            // --- Modals Close Buttons ---
            document.getElementById('closeScanner').addEventListener('click', () => {
                document.getElementById('scannerModal').classList.add('hidden');
                stopQuagga(); // Stop scanner when closing modal
            });
            document.getElementById('closeComponentRecognition').addEventListener('click', () => document.getElementById('componentRecognitionModal').classList.add('hidden'));
            document.getElementById('closeVersionHistory').addEventListener('click', () => document.getElementById('versionHistoryModal').classList.add('hidden'));
            document.getElementById('closeVersionHistoryTop').addEventListener('click', () => document.getElementById('versionHistoryModal').classList.add('hidden'));


            // --- Toggle Content for About Us Section ---
            document.querySelectorAll('.toggle-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const targetId = event.currentTarget.dataset.target;
                    const targetContent = document.getElementById(targetId);
                    const svgIcon = event.currentTarget.querySelector('svg');

                    if (targetContent.classList.contains('open')) {
                        targetContent.classList.remove('open');
                        svgIcon.style.transform = 'rotate(0deg)';
                    } else {
                        // Close other open sections
                        document.querySelectorAll('.toggle-content.open').forEach(openContent => {
                            openContent.classList.remove('open');
                            openContent.previousElementSibling.querySelector('svg').style.transform = 'rotate(0deg)';
                        });
                        targetContent.classList.add('open');
                        svgIcon.style.transform = 'rotate(180deg)';
                    }
                });
            });

            // --- Add PCB Section Logic ---
            const cameraInput = document.getElementById('cameraInput');
            const galleryInput = document.getElementById('galleryInput');
            const imagePreviewsContainer = document.getElementById('imagePreviewsContainer');
            const pictureNameInput = document.getElementById('pictureNameInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const addPictureButton = document.getElementById('addPictureButton');
            const cancelEditButton = document.getElementById('cancelEditButton');
            const addedPicturesList = document.getElementById('addedPicturesList');
            const noPicturesMessage = document.getElementById('noPicturesMessage');

            function resetAddPcbForm() {
                pictureNameInput.value = '';
                descriptionInput.value = '';
                imagePreviewsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center w-full">Upload images below.</p>';
                currentImages = [];
                currentPcbId = null; // Clear current PCB ID on reset
            }

            // Handle image selection/capture
            function handleImageUpload(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    imagePreviewsContainer.innerHTML = ''; // Clear existing previews
                    currentImages = []; // Clear existing images

                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgData = e.target.result;
                            currentImages.push(imgData); // Store base64 string

                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'relative w-24 h-24 rounded-lg overflow-hidden shadow-md group';
                            imgContainer.innerHTML = `
                                <img src="${imgData}" alt="PCB Preview" class="w-full h-full object-cover zoomable-image">
                                <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn" data-img="${imgData}">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            `;
                            imagePreviewsContainer.appendChild(imgContainer);

                            // Add zoom functionality
                            const zoomableImg = imgContainer.querySelector('.zoomable-image');
                            zoomableImg.addEventListener('click', () => {
                                zoomableImg.classList.toggle('zoomed');
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    if (currentImages.length === 0) {
                        imagePreviewsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center w-full">Upload images below.</p>';
                    }
                }
            }

            imagePreviewsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-image-btn')) {
                    const imgToRemove = event.target.dataset.img;
                    currentImages = currentImages.filter(img => img !== imgToRemove);
                    event.target.closest('.group').remove();
                    if (currentImages.length === 0) {
                        imagePreviewsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center w-full">Upload images below.</p>';
                    }
                }
            });

            cameraInput.addEventListener('change', handleImageUpload);
            galleryInput.addEventListener('change', handleImageUpload);

            addPictureButton.addEventListener('click', () => {
                const name = pictureNameInput.value.trim();
                const description = descriptionInput.value.trim();

                if (!name || currentImages.length === 0) {
                    showMessage('Please enter a PCB name and upload at least one image.', 'error');
                    return;
                }

                const newPcb = {
                    id: currentPcbId || Date.now().toString(), // Simple unique ID for local storage
                    name,
                    barcode: '', // Barcode is now only in Scan/Compare section
                    description,
                    imageUrls: currentImages, // Store base64 images directly
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    versionHistory: [] // Initialize version history
                };

                if (currentPcbId) {
                    // Update existing PCB
                    const pcbIndex = allPcbs.findIndex(pcb => pcb.id === currentPcbId);
                    if (pcbIndex > -1) {
                        const oldPcbData = JSON.parse(JSON.stringify(allPcbs[pcbIndex])); // Deep copy
                        // Add to version history
                        const versionEntry = {
                            version: oldPcbData.versionHistory ? oldPcbData.versionHistory.length + 1 : 1,
                            date: new Date().toISOString(),
                            changes: `Updated PCB details.`,
                            data: JSON.stringify(oldPcbData) // Store previous state as string
                        };
                        newPcb.versionHistory = [...(oldPcbData.versionHistory || []), versionEntry];
                        allPcbs[pcbIndex] = newPcb;
                        showMessage('PCB updated successfully!', 'success');
                    }
                } else {
                    // Add new PCB
                    newPcb.versionHistory.push({
                        version: 1,
                        date: new Date().toISOString(),
                        changes: "Initial creation",
                        data: JSON.stringify(newPcb) // Store initial state as string
                    });
                    allPcbs.push(newPcb);
                    showMessage('PCB added successfully!', 'success');
                }

                savePcbsToLocalStorage();
                resetAddPcbForm();
                renderAddedPicturesList(); // Refresh the list in Add PCB section
            });

            cancelEditButton.addEventListener('click', () => {
                resetAddPcbForm();
                document.getElementById('addPictureTitle').textContent = 'Add New PCB';
                document.getElementById('addPictureButton').textContent = 'Add PCB & Description';
                cancelEditButton.classList.add('hidden');
            });

            function renderAddedPicturesList() {
                addedPicturesList.innerHTML = '';
                if (allPcbs.length === 0) {
                    noPicturesMessage.classList.remove('hidden');
                    addedPicturesList.appendChild(noPicturesMessage);
                    return;
                }
                noPicturesMessage.classList.add('hidden');

                allPcbs.forEach(pcb => {
                    const pcbDiv = document.createElement('div');
                    pcbDiv.className = 'bg-gray-100 p-4 rounded-lg shadow-md flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4';
                    pcbDiv.innerHTML = `
                        <div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden border border-gray-300">
                            <img src="${pcb.imageUrls && pcb.imageUrls.length > 0 ? pcb.imageUrls[0] : 'https://placehold.co/96x96/cccccc/333333?text=No+Image'}" alt="${pcb.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-grow text-center md:text-left">
                            <h4 class="text-lg font-semibold text-gray-900">${pcb.name}</h4>
                            <p class="text-sm text-gray-600">Barcode: ${pcb.barcode || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${pcb.description || 'No description.'}</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button data-id="${pcb.id}" class="edit-pcb-btn bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition duration-200">Edit</button>
                            <button data-id="${pcb.id}" class="delete-pcb-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-200">Delete</button>
                            <button data-id="${pcb.id}" class="view-history-btn bg-indigo-500 text-white px-3 py-1 rounded-lg hover:bg-indigo-600 transition duration-200">History</button>
                        </div>
                    `;
                    addedPicturesList.appendChild(pcbDiv);
                });

                // Attach event listeners for edit/delete/history buttons
                document.querySelectorAll('.edit-pcb-btn').forEach(button => {
                    button.addEventListener('click', (e) => editPcb(e.target.dataset.id));
                });
                document.querySelectorAll('.delete-pcb-btn').forEach(button => {
                    button.addEventListener('click', (e) => deletePcb(e.target.dataset.id));
                });
                document.querySelectorAll('.view-history-btn').forEach(button => {
                    button.addEventListener('click', (e) => viewVersionHistory(e.target.dataset.id));
                });
            }

            function editPcb(pcbId) {
                const pcb = allPcbs.find(p => p.id === pcbId);
                if (pcb) {
                    showSection('addPictureSection');
                    document.getElementById('addPictureTitle').textContent = 'Edit PCB';
                    document.getElementById('addPictureButton').textContent = 'Update PCB';
                    cancelEditButton.classList.remove('hidden');

                    currentPcbId = pcb.id;
                    pictureNameInput.value = pcb.name;
                    descriptionInput.value = pcb.description || '';

                    imagePreviewsContainer.innerHTML = '';
                    currentImages = [];
                    if (pcb.imageUrls && pcb.imageUrls.length > 0) {
                        pcb.imageUrls.forEach(url => {
                            currentImages.push(url); // Store URLs directly for existing images
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'relative w-24 h-24 rounded-lg overflow-hidden shadow-md group';
                            imgContainer.innerHTML = `
                                <img src="${url}" alt="PCB Preview" class="w-full h-full object-cover zoomable-image">
                                <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity remove-image-btn" data-img="${url}">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            `;
                            imagePreviewsContainer.appendChild(imgContainer);
                            const zoomableImg = imgContainer.querySelector('.zoomable-image');
                            zoomableImg.addEventListener('click', () => {
                                zoomableImg.classList.toggle('zoomed');
                            });
                        });
                    } else {
                        imagePreviewsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center w-full">Upload images below.</p>';
                    }
                }
            }

            function deletePcb(pcbId) {
                if (confirm('Are you sure you want to delete this PCB?')) {
                    allPcbs = allPcbs.filter(pcb => pcb.id !== pcbId);
                    savePcbsToLocalStorage();
                    showMessage('PCB deleted successfully!', 'success');
                    renderAddedPicturesList(); // Refresh the list
                    renderDatabaseItems(); // Also refresh database view
                }
            }

            // --- Search Section Logic ---
            const searchQueryInput = document.getElementById('searchQueryInput');
            const searchButton = document.getElementById('searchButton');
            const resetSearchButton = document.getElementById('resetSearchButton');
            const searchResultsList = document.getElementById('searchResultsList');
            const noSearchResultsMessage = document.getElementById('noSearchResultsMessage');

            searchButton.addEventListener('click', performSearch);
            resetSearchButton.addEventListener('click', () => {
                searchQueryInput.value = '';
                performSearch(); // Perform search with empty filters to show all
            });

            function performSearch() {
                const queryText = searchQueryInput.value.toLowerCase();

                const filteredPcbs = allPcbs.filter(pcb => {
                    const matchesText = !queryText ||
                                        pcb.name.toLowerCase().includes(queryText) ||
                                        (pcb.description && pcb.description.toLowerCase().includes(queryText)) ||
                                        (pcb.barcode && pcb.barcode.toLowerCase().includes(queryText));
                    return matchesText;
                });

                renderSearchResults(filteredPcbs);
            }

            function renderSearchResults(results) {
                searchResultsList.innerHTML = '';
                if (results.length === 0) {
                    noSearchResultsMessage.classList.remove('hidden');
                    searchResultsList.appendChild(noPicturesMessage);
                    return;
                }
                noSearchResultsMessage.classList.add('hidden');

                results.forEach(pcb => {
                    const pcbDiv = document.createElement('div');
                    pcbDiv.className = 'bg-gray-100 p-4 rounded-lg shadow-md flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4';
                    pcbDiv.innerHTML = `
                        <div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden border border-gray-300">
                            <img src="${pcb.imageUrls && pcb.imageUrls.length > 0 ? pcb.imageUrls[0] : 'https://placehold.co/96x96/cccccc/333333?text=No+Image'}" alt="${pcb.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-grow text-center md:text-left">
                            <h4 class="text-lg font-semibold text-gray-900">${pcb.name}</h4>
                            <p class="text-sm text-gray-600">Barcode: ${pcb.barcode || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${pcb.description || 'N/A'}</p>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button data-id="${pcb.id}" class="edit-pcb-btn bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition duration-200">Edit</button>
                            <button data-id="${pcb.id}" class="delete-pcb-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-200">Delete</button>
                            <button data-id="${pcb.id}" class="view-history-btn bg-indigo-500 text-white px-3 py-1 rounded-lg hover:bg-indigo-600 transition duration-200">History</button>
                        </div>
                    `;
                    searchResultsList.appendChild(pcbDiv);
                });

                // Re-attach event listeners for edit/delete/history on search results
                document.querySelectorAll('#searchResultsList .edit-pcb-btn').forEach(button => {
                    button.addEventListener('click', (e) => editPcb(e.target.dataset.id));
                });
                document.querySelectorAll('#searchResultsList .delete-pcb-btn').forEach(button => {
                    button.addEventListener('click', (e) => deletePcb(e.target.dataset.id));
                });
                document.querySelectorAll('#searchResultsList .view-history-btn').forEach(button => {
                    button.addEventListener('click', (e) => viewVersionHistory(e.target.dataset.id));
                });
            }

            // --- Database Section Logic ---
            const databaseItemsTable = document.getElementById('databaseItemsTable');
            const itemCountSpan = document.getElementById('itemCount');
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            const prevPageButton = document.getElementById('prevPage');
            const nextPageButton = document.getElementById('nextPage');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const generatePdfButton = document.getElementById('generatePdfButton');
            const sharePdfButton = document.getElementById('sharePdfButton'); // New Share PDF button
            const exportCsvButton = document.getElementById('exportCsvButton');
            // const refreshDatabaseButton = document.getElementById('refreshDatabaseButton'); // Removed

            itemsPerPageSelect.addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1; // Reset to first page
                renderDatabaseItems();
            });
            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderDatabaseItems();
                }
            });
            nextPageButton.addEventListener('click', () => {
                const totalPages = Math.ceil(allPcbs.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderDatabaseItems();
                }
            });
            // refreshDatabaseButton.addEventListener('click', () => { // Removed event listener
            //     loadPcbsFromLocalStorage();
            //     renderDatabaseItems();
            // });

            function renderDatabaseItems() {
                databaseItemsTable.innerHTML = '';
                if (allPcbs.length === 0) {
                    databaseItemsTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No PCBs in database.</td></tr>';
                    itemCountSpan.textContent = '0';
                    currentPageSpan.textContent = '1';
                    totalPagesSpan.textContent = '1';
                    prevPageButton.disabled = true;
                    nextPageButton.disabled = true;
                    return;
                }

                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedPcbs = allPcbs.slice(startIndex, endIndex);

                paginatedPcbs.forEach(pcb => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-2 px-4 border">
                            <img src="${pcb.imageUrls && pcb.imageUrls.length > 0 ? pcb.imageUrls[0] : 'https://placehold.co/64x64/cccccc/333333?text=No+Image'}" alt="${pcb.name}" class="w-16 h-16 object-cover rounded-md mx-auto">
                        </td>
                        <td class="py-2 px-4 border text-gray-800 font-medium">${pcb.name}</td>
                        <td class="py-2 px-4 border text-gray-700">${pcb.barcode || 'N/A'}</td>
                        <td class="py-2 px-4 border">
                            <div class="flex flex-col space-y-1">
                                <button data-id="${pcb.id}" class="edit-pcb-btn bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-yellow-600 transition duration-200">Edit</button>
                                <button data-id="${pcb.id}" class="delete-pcb-btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition duration-200">Delete</button>
                                <button data-id="${pcb.id}" class="view-history-btn bg-indigo-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-indigo-600 transition duration-200">History</button>
                            </div>
                        </td>
                    `;
                    databaseItemsTable.appendChild(row);
                });

                // Update pagination controls
                itemCountSpan.textContent = allPcbs.length;
                const totalPages = Math.ceil(allPcbs.length / itemsPerPage);
                currentPageSpan.textContent = currentPage;
                totalPagesSpan.textContent = totalPages;
                prevPageButton.disabled = currentPage === 1;
                nextPageButton.disabled = currentPage === totalPages;

                // Attach event listeners for edit/delete/history buttons in the database table
                document.querySelectorAll('#databaseItemsTable .edit-pcb-btn').forEach(button => {
                    button.addEventListener('click', (e) => editPcb(e.target.dataset.id));
                });
                document.querySelectorAll('#databaseItemsTable .delete-pcb-btn').forEach(button => {
                    button.addEventListener('click', (e) => deletePcb(e.target.dataset.id));
                });
                document.querySelectorAll('#databaseItemsTable .view-history-btn').forEach(button => {
                    button.addEventListener('click', (e) => viewVersionHistory(e.target.dataset.id));
                });
            }

            generatePdfButton.addEventListener('click', () => {
                const element = document.getElementById('databaseItemsTable'); // Or a larger container
                html2pdf().from(element).save('E2S_PCB_Database.pdf');
                showMessage('PDF generated successfully!', 'success');
            });

            sharePdfButton.addEventListener('click', async () => {
                showMessage('Generating PDF for sharing...', 'info');
                const element = document.getElementById('databaseItemsTable');
                try {
                    const pdfBlob = await html2pdf().from(element).outputPdf('blob');
                    const fileName = 'E2S_PCB_Database.pdf';
                    const file = new File([pdfBlob], fileName, { type: 'application/pdf' });

                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: 'E2S PCB Database',
                            text: 'Here is the E2S PCB Database export.'
                        });
                        showMessage('PDF shared successfully via native share!', 'success');
                    } else {
                        // Fallback for environments where Web Share API is not available or cannot share files
                        const dataUrl = URL.createObjectURL(pdfBlob);
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(dataUrl); // Clean up the object URL

                        showMessage('PDF downloaded. Please check your downloads folder and use your device\'s share options (e.g., via email or Bluetooth) to share the file manually.', 'info');
                    }
                } catch (error) {
                    console.error('Error generating or sharing PDF:', error);
                    showMessage(`Failed to share PDF: ${error.message}. Please try again.`, 'error');
                }
            });


            exportCsvButton.addEventListener('click', () => {
                if (allPcbs.length === 0) {
                    showMessage('No data to export.', 'info');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Name,Barcode,Description,Image URLs,Created At,Updated At\n";

                allPcbs.forEach(pcb => {
                    const row = [
                        pcb.id,
                        `"${pcb.name.replace(/"/g, '""')}"`, // Handle commas and quotes
                        `"${(pcb.barcode || 'N/A').replace(/"/g, '""')}"`,
                        `"${(pcb.description || 'N/A').replace(/"/g, '""')}"`,
                        `"${(pcb.imageUrls || []).join('; ').replace(/"/g, '""')}"`,
                        `"${(pcb.createdAt || 'N/A').replace(/"/g, '""')}"`,
                        `"${(pcb.updatedAt || 'N/A').replace(/"/g, '""')}"`
                    ].join(',');
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "E2S_PCB_Database.csv");
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);
                showMessage('Database backed up successfully!', 'success');
            });

            // --- Version History Logic ---
            const versionHistoryModal = document.getElementById('versionHistoryModal');
            const versionHistoryTableBody = document.getElementById('versionHistoryTable');

            function viewVersionHistory(pcbId) {
                const pcb = allPcbs.find(p => p.id === pcbId);
                if (!pcb || !pcb.versionHistory || pcb.versionHistory.length === 0) {
                    versionHistoryTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No version history available for this PCB.</td></tr>';
                    versionHistoryModal.classList.remove('hidden');
                    return;
                }

                versionHistoryTableBody.innerHTML = '';
                // Sort history by version number or date if needed
                const sortedHistory = [...pcb.versionHistory].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA; // Newest first
                });

                sortedHistory.forEach(version => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    const date = new Date(version.date).toLocaleString();
                    row.innerHTML = `
                        <td class="py-2 px-4 border text-gray-800">${version.version || 'N/A'}</td>
                        <td class="py-2 px-4 border text-gray-700">${date}</td>
                        <td class="py-2 px-4 border text-gray-700">${version.changes || 'No specific changes recorded.'}</td>
                        <td class="py-2 px-4 border">
                            <button class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600 transition duration-200 view-version-data" data-data='${JSON.stringify(version.data)}'>View Data</button>
                        </td>
                    `;
                    versionHistoryTableBody.appendChild(row);
                });

                document.querySelectorAll('.view-version-data').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const versionData = JSON.parse(e.target.dataset.data);
                        showMessage(`Version Data: ${JSON.stringify(versionData, null, 2)}`, 'info');
                    });
                });

                versionHistoryModal.classList.remove('hidden');
            }

            // --- Barcode Scanner Logic (QuaggaJS) ---
            const scannerVideo = document.getElementById('scanner-video');
            const scannerResult = document.getElementById('scannerResult');
            const startScannerButton = document.getElementById('startScanner');
            const stopScannerButton = document.getElementById('stopScanner');
            const barcodeInputScanCompare = document.getElementById('barcodeInputScanCompare'); // New barcode input for Scan/Compare
            const scanBarcodeFromScanCompareButton = document.getElementById('scanBarcodeFromScanCompare'); // New scan button for Scan/Compare


            let quaggaInitialized = false;
            let currentScannerTargetInput = null; // To know which input to populate

            // Function to initialize Quagga with a target input
            function initQuagga(targetInput) {
                if (!quaggaInitialized) {
                    currentScannerTargetInput = targetInput;
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: scannerVideo,
                            constraints: {
                                facingMode: "environment"
                            },
                        },
                        decoder: {
                            readers: ["ean_reader", "code_128_reader", "qr_code_reader"]
                        }
                    }, function (err) {
                        if (err) {
                            console.error(err);
                            showMessage(`Error starting scanner: ${err.message}`, 'error');
                            return;
                        }
                        Quagga.start();
                        quaggaInitialized = true;
                        showMessage('Scanner started. Point camera at barcode/QR code.', 'info');
                    });

                    Quagga.onDetected(function (result) {
                        const code = result.codeResult.code;
                        scannerResult.textContent = `Detected: ${code}`;
                        if (currentScannerTargetInput) {
                            currentScannerTargetInput.value = code; // Populate the correct input
                        }
                        showMessage(`Barcode detected: ${code}`, 'success');
                        stopQuagga();
                        document.getElementById('scannerModal').classList.add('hidden');
                    });
                } else {
                    Quagga.start();
                    showMessage('Scanner resumed.', 'info');
                }
            }

            startScannerButton.addEventListener('click', () => {
                // This button is for the general scanner modal, it should populate the barcodeInputScanCompare
                initQuagga(barcodeInputScanCompare);
            });

            scanBarcodeFromScanCompareButton.addEventListener('click', () => {
                document.getElementById('scannerModal').classList.remove('hidden');
                initQuagga(barcodeInputScanCompare); // Ensure this button uses the correct input
            });

            stopScannerButton.addEventListener('click', stopQuagga);

            function stopQuagga() {
                if (quaggaInitialized) {
                    Quagga.stop();
                    quaggaInitialized = false;
                    showMessage('Scanner stopped.', 'info');
                }
            }

            // --- Component Recognition Logic (TensorFlow.js & COCO-SSD) ---
            const componentRecognitionInput = document.getElementById('componentRecognitionInput');
            const componentRecognitionImage = document.getElementById('componentRecognitionImage');
            const analyzeComponentsButton = document.getElementById('analyzeComponents');
            const componentResults = document.getElementById('componentResults');

            let objectDetectionModel;

            // Load the COCO-SSD model when the page loads or when the modal is opened
            async function loadObjectDetectionModel() {
                if (!objectDetectionModel) {
                    showMessage('Loading component recognition model... This may take a moment.', 'info');
                    try {
                        objectDetectionModel = await cocoSsd.load();
                        showMessage('Component recognition model loaded!', 'success');
                    } catch (error) {
                        showMessage(`Failed to load model: ${error.message}`, 'error');
                        console.error("Failed to load COCO-SSD model:", error);
                    }
                }
            }

            // Call this when the component recognition modal is opened
            document.getElementById('componentRecognitionModal').addEventListener('transitionend', (event) => {
                if (!document.getElementById('componentRecognitionModal').classList.contains('hidden')) {
                    loadObjectDetectionModel();
                }
            }, { once: false }); // Ensure it runs every time modal is opened

            componentRecognitionInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        componentRecognitionImage.src = e.target.result;
                        componentResults.innerHTML = '<p class="text-gray-500">Image loaded. Click "Analyze Components" to detect.</p>';
                    };
                    reader.readAsDataURL(file);
                } else {
                    componentRecognitionImage.src = 'https://placehold.co/400x200/cccccc/333333?text=Upload+PCB+Image';
                    componentResults.innerHTML = '<p class="text-gray-500">No components detected yet. Upload a PCB image to analyze.</p>';
                }
            });

            analyzeComponentsButton.addEventListener('click', async () => {
                if (!objectDetectionModel) {
                    showMessage('Model is still loading or failed to load. Please wait or check console.', 'error');
                    return;
                }
                if (!componentRecognitionImage.src || componentRecognitionImage.src.includes('placehold.co')) {
                    showMessage('Please upload a PCB image first.', 'error');
                    return;
                }

                showMessage('Analyzing components...', 'info');
                componentResults.innerHTML = '<p class="text-gray-500">Analyzing...</p>';

                try {
                    const predictions = await objectDetectionModel.detect(componentRecognitionImage);
                    
                    componentResults.innerHTML = '';
                    if (predictions.length === 0) {
                        componentResults.innerHTML = '<p class="text-gray-500">No components detected.</p>';
                        showMessage('No components detected.', 'info');
                        return;
                    }

                    predictions.forEach(prediction => {
                        const p = document.createElement('p');
                        p.className = 'mb-1';
                        p.textContent = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
                        componentResults.appendChild(p);
                    });
                    showMessage(`Detected ${predictions.length} components!`, 'success');

                } catch (error) {
                    showMessage(`Error during analysis: ${error.message}`, 'error');
                    console.error("Error detecting components:", error);
                    componentResults.innerHTML = '<p class="text-red-500">Error during analysis. See console for details.</p>';
                }
            });

            // --- Scan/Compare Section Logic ---
            const scanCompareCameraInput = document.getElementById('scanCompareCameraInput');
            const scanCompareImage = document.getElementById('scanCompareImage');
            const compareImageButton = document.getElementById('compareImageButton');
            const comparisonResults = document.getElementById('comparisonResults');

            let imageToCompare = null; // Stores the base64 string of the image captured for comparison

            scanCompareCameraInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageToCompare = e.target.result;
                        scanCompareImage.src = imageToCompare;
                        comparisonResults.innerHTML = '<p class="text-gray-500">Image captured. Click "Compare Image" to find a match.</p>';
                    };
                    reader.readAsDataURL(file);
                } else {
                    imageToCompare = null;
                    scanCompareImage.src = 'https://placehold.co/400x200/cccccc/333333?text=Capture+Image';
                    comparisonResults.innerHTML = '<p class="text-gray-500">Capture an image and click "Compare" to find a match.</p>';
                }
            });

            compareImageButton.addEventListener('click', () => {
                if (!imageToCompare) {
                    showMessage('Please capture an image first for comparison.', 'error');
                    return;
                }

                comparisonResults.innerHTML = '<p class="text-gray-500">Comparing image with database...</p>';
                showMessage('Performing image comparison...', 'info');

                // --- SIMULATED IMAGE COMPARISON LOGIC ---
                // In a real application, this would involve a robust image comparison algorithm.
                // This could be:
                // 1. Feature matching (e.g., using OpenCV.js)
                // 2. Perceptual hashing (comparing image "fingerprints")
                // 3. Machine learning model (e.g., a siamese network trained for similarity)
                // 4. Server-side image processing

                // For this demonstration, we'll simulate a match based on a very simple criteria
                // or just show a "no match found" after a delay.
                // A very basic, unreliable "comparison" could be by exact base64 string match,
                // but this is highly unlikely to work for real camera captures due to compression, lighting, etc.

                setTimeout(() => {
                    let matchFound = false;
                    let matchedPcb = null;

                    // A very basic and unreliable "comparison" for demonstration purposes:
                    // Iterate through all stored PCBs and check if the captured image's base64 string
                    // is present in any of the stored PCB's imageUrls.
                    // This is highly unlikely to work for real camera captures due to variations.
                    for (const pcb of allPcbs) {
                        if (pcb.imageUrls && pcb.imageUrls.includes(imageToCompare)) {
                            matchFound = true;
                            matchedPcb = pcb;
                            break;
                        }
                    }

                    // A more realistic simulation for demonstration:
                    // If no exact match, let's just pick a random PCB from the database if there are any,
                    // or say no match if none, to show the flow.
                    if (!matchFound && allPcbs.length > 0 && Math.random() > 0.5) { // 50% chance of a "simulated" match if no exact match
                         matchedPcb = allPcbs[Math.floor(Math.random() * allPcbs.length)];
                         matchFound = true;
                    }


                    if (matchFound && matchedPcb) {
                        comparisonResults.innerHTML = `
                            <p class="text-green-700 font-semibold">Match Found!</p>
                            <p class="text-gray-800">Identified PCB: <span class="font-bold">${matchedPcb.name}</span></p>
                            <p class="text-gray-600">Barcode: ${matchedPcb.barcode || 'N/A'}</p>
                            <p class="text-gray-600">Description: ${matchedPcb.description || 'N/A'}</p>
                            <div class="mt-2">
                                <img src="${matchedPcb.imageUrls && matchedPcb.imageUrls.length > 0 ? matchedPcb.imageUrls[0] : 'https://placehold.co/100x100/cccccc/333333?text=No+Image'}" alt="Matched PCB" class="w-24 h-24 object-cover rounded-md mx-auto">
                            </div>
                        `;
                        showMessage(`PCB matched: ${matchedPcb.name}`, 'success');
                    } else {
                        comparisonResults.innerHTML = '<p class="text-red-700 font-semibold">No direct match found in database.</p><p class="text-gray-600">Try adjusting lighting or angle, or add this PCB if it\'s new.</p>';
                        showMessage('No PCB matched.', 'info');
                    }
                }, 2000); // Simulate processing time
            });

            // --- Settings Theme Logic ---
            const themeSelect = document.getElementById('themeSelect');
            const backupDataButton = document.getElementById('backupDataButton');
            const restoreDataButton = document.getElementById('restoreDataButton');
            const restoreFileInput = document.getElementById('restoreFileInput');
            const homepageImageInput = document.getElementById('homepageImageInput');
            const applyHomepageImageButton = document.getElementById('applyHomepageImageButton');
            const homePageDisplayImage = document.getElementById('homePageDisplayImage');


            function applyTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }

            themeSelect.addEventListener('change', (event) => {
                applyTheme(event.target.value);
            });

            // Backup Data
            backupDataButton.addEventListener('click', () => {
                if (allPcbs.length === 0) {
                    showMessage('No data to backup.', 'info');
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Name,Barcode,Description,Image URLs,Created At,Updated At,Version History\n";

                allPcbs.forEach(pcb => {
                    const row = [
                        pcb.id,
                        `"${pcb.name.replace(/"/g, '""')}"`,
                        `"${(pcb.barcode || 'N/A').replace(/"/g, '""')}"`,
                        `"${(pcb.description || 'N/A').replace(/"/g, '""')}"`,
                        `"${(pcb.imageUrls || []).join('; ').replace(/"/g, '""')}"`,
                        `"${(pcb.createdAt || 'N/A').replace(/"/g, '""')}"`,
                        `"${(pcb.updatedAt || 'N/A').replace(/"/g, '""')}"`,
                        `"${JSON.stringify(pcb.versionHistory || []).replace(/"/g, '""')}"` // Stringify version history
                    ].join(',');
                    csvContent += row + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", "E2S_PCB_Backup.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('Database backed up successfully to E2S_PCB_Backup.csv!', 'success');
            });

            // Restore Data
            restoreDataButton.addEventListener('click', () => {
                // Trigger the hidden file input click
                restoreFileInput.click();
            });

            restoreFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                if (!file.name.endsWith('.csv')) {
                    showMessage('Please select a CSV file.', 'error');
                    return;
                }

                if (!confirm('Restoring data will overwrite your current database. Are you sure you want to continue?')) {
                    // Clear the file input so the same file can be selected again if needed
                    restoreFileInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvText = e.target.result;
                        const lines = csvText.split('\n').filter(line => line.trim() !== '');
                        if (lines.length === 0) {
                            showMessage('Selected CSV file is empty.', 'error');
                            return;
                        }

                        const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, '')); // Remove quotes
                        const newPcbs = [];

                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCsvLine(lines[i]); // Use a robust CSV parser
                            if (values.length !== headers.length) {
                                console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                                continue; // Skip malformed rows
                            }

                            const pcb = {};
                            headers.forEach((header, index) => {
                                let value = values[index];
                                if (header === "Image URLs") {
                                    pcb[header.replace(' ', '')] = value ? value.split('; ').map(url => url.trim()) : [];
                                } else if (header === "Version History") {
                                    try {
                                        pcb[header.replace(' ', '')] = value ? JSON.parse(value) : [];
                                    } catch (jsonError) {
                                        console.error(`Error parsing Version History JSON for row ${i + 1}:`, jsonError);
                                        pcb[header.replace(' ', '')] = []; // Default to empty array on error
                                    }
                                }
                                else {
                                    pcb[header.replace(' ', '')] = value; // Remove spaces from header for property name
                                }
                            });
                            newPcbs.push(pcb);
                        }

                        allPcbs = newPcbs;
                        savePcbsToLocalStorage();
                        showMessage('Database restored successfully from CSV!', 'success');
                        renderAddedPicturesList(); // Refresh Add PCB list
                        renderDatabaseItems(); // Refresh Database list

                    } catch (error) {
                        showMessage(`Error restoring data: ${error.message}. Please ensure the CSV format is correct.`, 'error');
                        console.error('Error during CSV restore:', error);
                    } finally {
                        // Clear the file input after processing
                        restoreFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // A more robust CSV line parser to handle commas within quoted fields
            function parseCsvLine(line) {
                const result = [];
                let inQuote = false;
                let currentField = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuote && i + 1 < line.length && line[i + 1] === '"') {
                            // Escaped quote: "" becomes "
                            currentField += '"';
                            i++;
                        } else {
                            inQuote = !inQuote;
                        }
                    } else if (char === ',' && !inQuote) {
                        result.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField.trim()); // Add the last field
                return result;
            }

            // Homepage Image Upload Logic
            homepageImageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Store the base64 string in local storage
                        localStorage.setItem('homepageImage', e.target.result);
                        showMessage('Homepage image selected. Click "Apply" to set it.', 'info');
                    };
                    reader.readAsDataURL(file);
                }
            });

            applyHomepageImageButton.addEventListener('click', () => {
                const storedImage = localStorage.getItem('homepageImage');
                if (storedImage) {
                    homePageDisplayImage.src = storedImage;
                    showMessage('Homepage image applied successfully!', 'success');
                } else {
                    showMessage('No image selected to apply.', 'error');
                }
            });

            // Load theme and homepage image on initial page load
            document.addEventListener('DOMContentLoaded', () => {
                loadPcbsFromLocalStorage(); // Load PCBs on app start
                renderAddedPicturesList(); // Render list in Add PCB section
                showSection('homeSection'); // Show home section by default

                // Load and apply saved theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                themeSelect.value = savedTheme;
                applyTheme(savedTheme);

                // Load and apply saved homepage image
                const savedHomepageImage = localStorage.getItem('homepageImage');
                if (savedHomepageImage) {
                    homePageDisplayImage.src = savedHomepageImage;
                } else {
                    homePageDisplayImage.src = "https://placehold.co/400x200/cccccc/333333?text=No+Homepage+Image";
                }
            });

        </script>
    </div>
</body>
</html>
